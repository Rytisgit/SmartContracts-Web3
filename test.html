<!DOCTYPE html>
<html>
	<head>
		<title></title>
		<meta charset="utf-8" />	
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Shipment Administration</title>
		<link rel="stylesheet" type="text/css" href="css/normalize.css" />
		<link rel="stylesheet" type="text/css" href="css/vicons-font.css" />
		<link rel="stylesheet" type="text/css" href="css/base.css" />
		<link rel="stylesheet" type="text/css" href="css/buttons.css" />
	</head>
	<script src = "https://maps.googleapis.com/maps/api/js"></script>
	
	<style>
	.form {
        margin: 0 auto;
        width: 350px;
    }
    .form label{
        display: inline-block;
        text-align: right;
        float: left;
    }
    .form input{
        display: inline-block;
        text-align: left;
        float: right;
    }</style>
	<script src="./web3.min.js"></script>
	<script src="./abi.js"></script>
	<script src="./shippingcompany.js"></script>
	<body class = "bg-3">
		<script>
			window.addEventListener('load', async () => {
			    // Modern dapp browsers...
			    if (window.ethereum) {
			        window.web3 = new Web3(ethereum);
			        try {
			            // Request account access if needed
			            await ethereum.enable();
						globalAddress = (await web3.eth.getAccounts())[0]
			            globalContract = new web3.eth.Contract(deliveryabi);
			        } catch (error) {
			            // User denied account access...
			        }
			    }
			    // Legacy dapp browsers...
			    else if (window.web3) {
			        window.web3 = new Web3(web3.currentProvider);
			        var accounts = await web3.eth.getAccounts();
					currentAccount = accounts[0];
			    }
			    // Non-dapp browsers...
			    else {
			        console.log('Non-Ethereum browser detected. You should consider trying MetaMask!');
			    }
			});


			
			var globalAddress;
			var globalContract;
			var currentAddress;

			function createContract() {
				try {
					var add = document.getElementById("Adress").value;
					var good = document.getElementById("Goods").value;
					var quant = parseInt(document.getElementById("quantity").value);
					var price = parseInt(document.getElementById("price").value);
					var disc = parseInt(document.getElementById("Discount").value);
					var freq = parseInt(document.getElementById("LocationFrequency").value);
					var locatio = document.getElementById("DeliveryLocation").value;
					var time = parseInt(document.getElementById("DeliveryTime").value);
					var bytes = "0x6080604052604051620014be380380620014be83398181016040526101008110156200002a57600080fd5b8101908080519060200190929190805160405193929190846401000000008211156200005557600080fd5b838201915060208201858111156200006c57600080fd5b82518660018202830111640100000000821117156200008a57600080fd5b8083526020830192505050908051906020019080838360005b83811015620000c0578082015181840152602081019050620000a3565b50505050905090810190601f168015620000ee5780820380516001836020036101000a031916815260200191505b5060405260200180519060200190929190805190602001909291908051906020019092919080519060200190929190805160405193929190846401000000008211156200013a57600080fd5b838201915060208201858111156200015157600080fd5b82518660018202830111640100000000821117156200016f57600080fd5b8083526020830192505050908051906020019080838360005b83811015620001a557808201518184015260208101905062000188565b50505050905090810190601f168015620001d35780820380516001836020036101000a031916815260200191505b5060405260200180519060200190929190505050336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060405180610120016040528088815260200187815260200186815260200185815260200142815260200184815260200183815260200182815260200160001515815250600260008201518160000190805190602001906200028a92919062000359565b506020820151816001015560408201518160020155606082015181600301556080820151816004015560a0820151816005015560c0820151816006019080519060200190620002db92919062000359565b5060e082015181600701556101008201518160080160006101000a81548160ff02191690831515021790555090505087600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550505050505050505062000408565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106200039c57805160ff1916838001178555620003cd565b82800160010185558215620003cd579182015b82811115620003cc578251825591602001919060010190620003af565b5b509050620003dc9190620003e0565b5090565b6200040591905b8082111562000401576000816000905550600101620003e7565b5090565b90565b6110a680620004186000396000f3fe6080604052600436106100915760003560e01c8063b9e0db3511610059578063b9e0db35146102c7578063bbdfbfba14610382578063bf15071d1461038c578063d17d3503146104bd578063e8124441146104c757610091565b80637633a22c146100965780638da5cb5b14610126578063a5183e591461017d578063a877f215146101a8578063ac1cf956146101ff575b600080fd5b3480156100a257600080fd5b506100ab6104d1565b6040518080602001828103825283818151815260200191508051906020019080838360005b838110156100eb5780820151818401526020810190506100d0565b50505050905090810190601f1680156101185780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34801561013257600080fd5b5061013b61050e565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34801561018957600080fd5b50610192610533565b6040518082815260200191505060405180910390f35b3480156101b457600080fd5b506101bd610540565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34801561020b57600080fd5b506102c56004803603602081101561022257600080fd5b810190808035906020019064010000000081111561023f57600080fd5b82018360208201111561025157600080fd5b8035906020019184600183028401116401000000008311171561027357600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f820116905080830192505050505050509192919290505050610566565b005b3480156102d357600080fd5b50610300600480360360208110156102ea57600080fd5b81019080803590602001909291905050506106f1565b6040518080602001838152602001828103825284818151815260200191508051906020019080838360005b8381101561034657808201518184015260208101905061032b565b50505050905090810190601f1680156103735780820380516001836020036101000a031916815260200191505b50935050505060405180910390f35b61038a6107ba565b005b34801561039857600080fd5b506103a1610af5565b60405180806020018a8152602001898152602001888152602001878152602001868152602001806020018581526020018415151515815260200183810383528c818151815260200191508051906020019080838360005b838110156104135780820151818401526020810190506103f8565b50505050905090810190601f1680156104405780820380516001836020036101000a031916815260200191505b50838103825286818151815260200191508051906020019080838360005b8381101561047957808201518184015260208101905061045e565b50505050905090810190601f1680156104a65780820380516001836020036101000a031916815260200191505b509b50505050505050505050505060405180910390f35b6104c5610c6e565b005b6104cf610eab565b005b60606040518060400160405280600781526020017f72756e6e696e6700000000000000000000000000000000000000000000000000815250905090565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b6000600b80549050905090565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600260080160009054906101000a900460ff1661058257600080fd5b3373ffffffffffffffffffffffffffffffffffffffff166000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16146105db57600080fd5b6105e3610fb2565b818160000181905250428160200181815250506001600b82908060018154018082558091505090600182039060005260206000209060020201600090919290919091506000820151816000019080519060200190610642929190610fcc565b5060208201518160010155505050507fdb6cff65287c5dccc0d31ed5fdabffd31ff758bafb419c6cc5664f12cfc82933826040518080602001828103825283818151815260200191508051906020019080838360005b838110156106b3578082015181840152602081019050610698565b50505050905090810190601f1680156106e05780820380516001836020036101000a031916815260200191505b509250505060405180910390a15050565b600b81815481106106fe57fe5b9060005260206000209060020201600091509050806000018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156107aa5780601f1061077f576101008083540402835291602001916107aa565b820191906000526020600020905b81548152906001019060200180831161078d57829003601f168201915b5050505050908060010154905082565b600260080160009054906101000a900460ff166107d657600080fd5b3373ffffffffffffffffffffffffffffffffffffffff166000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161461082f57600080fd5b600260050154600b805490501015801561085457504260026007015460026004015401105b156108a9573373ffffffffffffffffffffffffffffffffffffffff166108fc60028001549081150290604051600060405180830381858888f193505050501580156108a3573d6000803e3d6000fd5b50610976565b3373ffffffffffffffffffffffffffffffffffffffff166108fc6002600301546002800154039081150290604051600060405180830381858888f193505050501580156108fa573d6000803e3d6000fd5b50600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc6002600301546002800154036002800154039081150290604051600060405180830381858888f19350505050158015610974573d6000803e3d6000fd5b505b7f0c82e48ec0a0e3ddfa56dfb88b1ce20bc142aefd3ea91939413271e2714db16c600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff166002600001600260010154426000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff16604051808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001806020018581526020018481526020018373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001828103825286818154600181600116156101000203166002900481526020019150805460018160011615610100020316600290048015610ae15780601f10610ab657610100808354040283529160200191610ae1565b820191906000526020600020905b815481529060010190602001808311610ac457829003601f168201915b5050965050505050505060405180910390a1565b6002806000018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610b8f5780601f10610b6457610100808354040283529160200191610b8f565b820191906000526020600020905b815481529060010190602001808311610b7257829003601f168201915b505050505090806001015490806002015490806003015490806004015490806005015490806006018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610c4b5780601f10610c2057610100808354040283529160200191610c4b565b820191906000526020600020905b815481529060010190602001808311610c2e57829003601f168201915b5050505050908060070154908060080160009054906101000a900460ff16905089565b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610cc857600080fd5b600260080160009054906101000a900460ff1615610ce557600080fd5b34600280015414610cf557600080fd5b6001600260080160006101000a81548160ff021916908315150217905550426002600401819055507fc8a83784a5d8ee8bc63112a383d256ef1b87a8ea099a92d6ce8298b450724e973360026000016002600101546002600601604051808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018060200184815260200180602001838103835286818154600181600116156101000203166002900481526020019150805460018160011615610100020316600290048015610e145780601f10610de957610100808354040283529160200191610e14565b820191906000526020600020905b815481529060010190602001808311610df757829003601f168201915b5050838103825284818154600181600116156101000203166002900481526020019150805460018160011615610100020316600290048015610e975780601f10610e6c57610100808354040283529160200191610e97565b820191906000526020600020905b815481529060010190602001808311610e7a57829003601f168201915b5050965050505050505060405180910390a1565b600260080160009054906101000a900460ff16610ec757600080fd5b426002600701546002600401540110610edf57600080fd5b3373ffffffffffffffffffffffffffffffffffffffff16600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614610f3957600080fd5b3373ffffffffffffffffffffffffffffffffffffffff166108fc60028001549081150290604051600060405180830381858888f19350505050158015610f83573d6000803e3d6000fd5b507f8616bbbbad963e4e65b1366f1d75dfb63f9e9704bbbf91fb01bec70849906cf760405160405180910390a1565b604051806040016040528060608152602001600081525090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061100d57805160ff191683800117855561103b565b8280016001018555821561103b579182015b8281111561103a57825182559160200191906001019061101f565b5b509050611048919061104c565b5090565b61106e91905b8082111561106a576000816000905550600101611052565b5090565b9056fea265627a7a72315820f158fd45504e9e9089ef4e56c8c51ff31ded32e3405cbade55eb5f6efa63236e64736f6c634300050f0032"
					globalContract.deploy({data : bytes, arguments: [add,good,quant,price,disc,freq,locatio,time]})
					.send({from: globalAddress, gas: 5000000})
					.then( (res, err) => {
						if (!err) {
							console.log(res);
							globalContract = new web3.eth.Contract(deliveryabi, res._address);
							alert(res._address)
						} else {
							console.log(err);
						}
					});
				} catch (err) {
					console.log(err);
				}
			}

	function reopen() { 
	var address = document.getElementById("shipmentid").value;
	globalContract = new web3.eth.Contract(deliveryabi, address);
	for(var i = 0; i<document.getElementsByClassName("hider").length; i++){document.getElementsByClassName("hider")[i].style.visibility = "visible"}
	updateDisplay(); 
		
 }

			function updateLocation() {
				try {
					globalContract.methods.sendLocationUpdate(document.getElementById("InsertLocation").value)
					.send({from: globalAddress}).then((res, err)=>{if(!err){console.log(res)}else{console.log(err)}})
				}
				catch (err) {
					console.log(err);
				}
			}

			function updateDisplay(){
				try {
					globalContract.methods.order().call({from: globalAddress}).then((result, error) => {
						if (!error) {
						document.getElementById("Adress").value = globalAddress;
							document.getElementById("Goods").value = result[0];
							document.getElementById("quantity").value = result[1];
							document.getElementById("price").value = result[2];
							document.getElementById("Discount").value = result[3];
							document.getElementById("LocationFrequency").value = result[7];
							document.getElementById("DeliveryLocation").value = result[6];
							document.getElementById("DeliveryTime").value = result[4];
							document.getElementById("Accepted").value = result[8];
							console.log(result);
						} else {
							console.log(error);
						}
					});
				}
				catch (err) {
					console.log(err);
				}
			}
			

			function delivered(){
				 globalContract.methods.delivered().send({from: globalAddress, gas: 5000000, gasPrice: 8}).then((res,err)=>{if(err){alert("taking deposit failed")} else{console.log("delivered")}})
			}
		</script>
		<center>
			<div id="metamask"></div>
			<h1>Shipment Administration Service</h1>
			<br />
			<form id="PlaceOrder">
				<table class = "form">
					<tr>
						<td>
						<label>Adress</label>
							<input id="Adress" type="text" required />
						</td>
					</tr>
					<tr>
						<td>
						<label>Goods</label>
							<input id="Goods" type="text" required/>
						</td>
					</tr>
					<tr>
						<td>
						<label>quantity</label>
							<input id="quantity" type="number" required />
						</td>
					</tr>
					<tr>
						<td>
						<label>price</label>
							<input id="price" type="number" required/>
						</td>
					</tr>
					<tr>
						<td>
						<label>Discount</label>
							<input id="Discount" type="number" required/>
						</td>
					</tr>
										<tr>
						<td>
						<label>LocationFrequency</label>
							<input id="LocationFrequency" type="number" required/>
						</td>
					</tr>
										<tr>
						<td>
						<label>DeliveryLocation</label>
							<input id="DeliveryLocation" type="text" required/>
						</td>
					</tr>
										<tr>
						<td>
						<label>DeliveryTime</label>
							<input id="DeliveryTime" type="number" required/>
						</td>
					</tr>
															<tr>
						<td>
						<label>Accepted</label>
							<input id="Accepted" type="text" required/>
						</td>
					</tr>
					<tr>
						<td>
							<button id="Offer" type="button" class="button button--wapasha button--round-l button--text-thick button--inverted"  onclick="createContract()">Offer Shipment</button>
						</td>
					</tr>
																				<tr>
						<td>
						<label>CurrentLocation</label>
							<input id="InsertLocation" type="text" required/>
						</td>
					</tr>
					<tr>
						<td>
							<button id="BUtton2" type="button" class="button button--wapasha button--round-l button--text-thick button--inverted" onclick="updateLocation()">Update Location</button>
						</td>
					</tr>
																			<tr>
						<td>
						<label>Shipment to reopen</label>
							<input id="shipmentid" type="text" required/>
						</td>
					</tr>
					<tr>
						<td>
							<button id="BUtton3" type="button" class="button button--wapasha button--round-l button--text-thick button--inverted" onclick="reopen()">Reopen</button>
						</td>
					</tr>
										<tr>
						<td>
							<button id="BUtton4" type="button" class="button button--wapasha button--round-l button--text-thick button--inverted" onclick="delivered()">Delivered</button>
						</td>
					</tr>
				</table>
			</form>

		</center>
	</body>
</html>
